#!/usr/bin/env bash
set -euo pipefail

# Define 'devname'
devname="NeosLab"

# Define 'devmail'
devmail="info@neoslab.com"

# Define 'appname'
appname="MediaSane"

# Define 'debname'
debname="mediasane"

# Define 'debvers'
debvers="1.1.1"

# Define 'debarch'
debarch="all"

# Define 'execpath'
execpath="/usr/bin/${debname}"

# Define 'execfile'
execfile="main.py"

# Define 'pathdir'
pathdir="$(pwd)"

# Define 'pathtmp'
pathtmp="$(mktemp -d -t ${debname}.XXXXXXXX)"

# Define 'pkgroot'
pkgroot="${pathtmp}/${debname}"

# Prepare environment
rm -rf "${pathdir}/dist"
rm -rf "${pathtmp}"

# Build layout
mkdir -p "${pkgroot}/DEBIAN"
mkdir -p "${pkgroot}/usr/bin"
mkdir -p "${pkgroot}/usr/share/applications"
mkdir -p "${pkgroot}/usr/share/pixmaps"

# Create 'control' file
cat > "${pkgroot}/DEBIAN/control" <<EOF
Package: ${debname}
Version: ${debvers}
Section: utils
Priority: optional
Architecture: ${debarch}
Depends: python3, python3-pyqt6
Maintainer: ${devname} <${devmail}>
Description: ${appname} - Media Rename GUI (source package)
 ${appname} is a PyQt6 GUI to organize and rename photos/videos
 by date using EXIF or file metadata, detect duplicates, and
 safely move or delete files with a dry-run preview mode.
EOF

# Create 'preinst' file
cat > "${pkgroot}/DEBIAN/preinst" <<'EOF'
#!/bin/sh
set -e
echo "Clean legacy locations from old packages..."
rm -f /usr/local/bin/mediasane
rm -f /usr/share/pixmaps/mediasane.png
rm -f /usr/share/applications/mediasane.desktop
sleep 1s
exit 0
EOF

# Create 'postinst' file
cat > "${pkgroot}/DEBIAN/postinst" <<'EOF'
#!/bin/sh
set -e
echo "Updating desktop launcher..."
command -v update-desktop-database >/dev/null 2>&1 && update-desktop-database
sleep 1s
exit 0
EOF

# Update files permission
chmod 0755 "${pkgroot}/DEBIAN/preinst" "${pkgroot}/DEBIAN/postinst"

# Ensure your main.py has a Python3 shebang '#!/usr/bin/env python3'
install -m 0755 "${execfile}" "${pkgroot}${execpath}"

# Install package icon
install -m 0644 "assets/images/${debname}.png" "${pkgroot}/usr/share/pixmaps/${debname}.png"

# Create desktop launcher
cat > "${pkgroot}/usr/share/applications/${debname}.desktop" <<EOF
[Desktop Entry]
Type=Application
Name=${appname}
GenericName=System Cleanup
Comment=Ubuntu cleanup GUI for caches, logs, snaps and more
Exec=${execpath}
TryExec=${execpath}
Icon=/usr/share/pixmaps/${debname}.png
Terminal=false
Categories=System;Utility;
StartupNotify=true
Keywords=cleanup;cache;system;maintenance;ubuntu;
EOF
chmod 0644 "${pkgroot}/usr/share/applications/${debname}.desktop"

# Build deb package
cd "${pathtmp}"
dpkg-deb --build --root-owner-group "${debname}"

# Output file named with arch that matches control
mkdir -p "${pathdir}/dist" 
mv "${pathtmp}/${debname}.deb" "${pathdir}/dist/${debname}_${debvers}_${debarch}.deb"
echo "Built: ${pathdir}/dist/${debname}_${debvers}_${debarch}.deb"
cd "${pathdir}"